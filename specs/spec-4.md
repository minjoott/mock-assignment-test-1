# Spec 4: 배송 최적화 로직 구현

## 1. 명세 및 요구사항 정리

### 1.1 비기능 요구사항
- 가능하면 한 창고에서 모든 상품을 보내는 것이 좋다
- 고객 위치와 가까운 창고를 우선한다
- 배송비가 적게 드는 방법을 선택한다

### 1.2 최적화 목표
**우선순위**:
1. 단일 창고 배송 (배송비 최소화)
2. 배송비 총합 최소화
3. 배송 일수 최소화

## 2. 구현할 작업 범위

### 2.1 배송 전략 인터페이스
- `ShippingStrategy` 인터페이스 정의
- 다양한 최적화 전략을 구현할 수 있는 구조

### 2.2 최적화 알고리즘 구현
- `OptimalShippingStrategy` 구현
  - 단일 창고 배송 가능 여부 확인
  - 단일 창고 중 최적 창고 선택
  - 불가능 시 다중 창고 조합 최적화

### 2.3 Service 레이어 개선
- `ShippingService` 분리
- `OrderService`에서 배송 전략 활용

## 3. 고려 사항 및 제약 조건

### 3.1 최적화 로직 설계
**단일 창고 배송 우선**:
1. 각 창고별로 모든 주문 상품 배송 가능 여부 확인
2. 가능한 창고 중 배송비가 가장 저렴한 창고 선택
3. 배송비가 동일하면 배송 일수가 짧은 창고 선택

**다중 창고 배송**:
1. 상품별로 재고가 있는 창고 찾기
2. 배송비 총합이 최소가 되도록 조합 선택
3. 동일 배송비면 창고 개수가 적은 조합 선택

### 3.2 성능 고려
- 창고 및 상품 개수가 적어 전체 탐색 가능
- 필요 시 캐싱 또는 최적화 알고리즘 적용

### 3.3 확장성
- 고객 위치 정보 추가 시 대응 가능한 구조
- 배송 우선순위 정책 변경 용이

## 4. 설계 방향

### 4.1 전략 패턴 적용
```java
public interface ShippingStrategy {
    List<Shipment> allocate(Order order, List<OrderItem> items);
}

public class OptimalShippingStrategy implements ShippingStrategy {
    // 최적화 로직 구현
}
```

### 4.2 최적화 알고리즘 흐름
```
1. 단일 창고 배송 시도
   ├─ 모든 창고 순회
   ├─ 각 창고에서 전체 주문 이행 가능 여부 확인
   └─ 가능한 창고 중 최저 비용 선택

2. 단일 창고 불가 시
   ├─ 상품별 가능 창고 매핑
   ├─ 조합 생성
   └─ 최소 비용 조합 선택
```

### 4.3 비용 계산
- 총 배송비 = Σ(각 창고 배송비)
- 동일 배송비 시 배송일 고려
- 동일 배송일 시 창고 개수 고려

## 5. 테스트 방향

### 5.1 단위 테스트
- ShippingStrategy 로직 테스트
  - 단일 창고 배송 가능 케이스
  - 다중 창고 배송 필요 케이스
  - 최적 창고 선택 검증
  - 배송비 계산 검증

### 5.2 시나리오 테스트
- 실제 주문 케이스별 최적화 검증
  - 서울 창고만으로 가능한 주문
  - 여러 창고 필요한 주문
  - 배송비 비교 검증
